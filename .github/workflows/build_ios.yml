name: Build iOS IPA (TrollStore Force Success)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install Dependencies
        run: |
          flutter pub get
          cd ios && pod install --repo-update && cd ..

      - name: Inject Dummy Team ID & Fix Signing
        run: |
          # 1. تعيين الـ Bundle ID والـ Team ID الوهمي لخداع Xcode
          sed -i '' 's/com.example.[a-zA-Z0-9]*/com.raseed.app/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/DEVELOPMENT_TEAM = [^;]*/DEVELOPMENT_TEAM = OPQ1234567/g' ios/Runner.xcodeproj/project.pbxproj
          
          # 2. إجبار النظام على استخدام التوقيع اليدوي (Manual) وتخطي الفحص
          echo "CODE_SIGNING_ALLOWED=NO" >> ios/Flutter/Generated.xcconfig
          echo "CODE_SIGNING_REQUIRED=NO" >> ios/Flutter/Generated.xcconfig
          echo "CODE_SIGN_STYLE=Manual" >> ios/Flutter/Generated.xcconfig
          echo "PROVISIONING_PROFILE_SPECIFIER=" >> ios/Flutter/Generated.xcconfig

      - name: Build iOS App Bundle
        run: |
          # سنبني نسخة Release مع تعطيل التوقيع تماماً
          flutter build ios --release --no-codesign

      - name: Create IPA for TrollStore
        run: |
          mkdir -p Payload
          # البحث الديناميكي عن ملف الـ .app لضمان عدم حدوث خطأ في المسار
          APP_PATH=$(find build/ios/iphoneos -name "Runner.app" -type d | head -n 1)
          if [ -n "$APP_PATH" ]; then
            cp -r "$APP_PATH" Payload/
            zip -r Raseed.ipa Payload
          else
            echo "Error: Runner.app not found. Trying debug build logic..."
            exit 1
          fi
          
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Raseed-App-IPA
          path: Raseed.ipa
