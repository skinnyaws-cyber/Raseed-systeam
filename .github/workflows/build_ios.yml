name: Build iOS IPA (True Fakesign During Build)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install Dependencies
        run: flutter pub get

      - name: Configure Project for Ad-Hoc Signing
        run: |
          # تغيير الـ Bundle ID
          sed -i '' 's/com.example.[a-zA-Z0-9]*/com.raseed.app/g' ios/Runner.xcodeproj/project.pbxproj
          
          # إجبار المشروع على قبول التوقيع الزائف (Ad-Hoc) كأنه أمر واقع
          echo "CODE_SIGNING_ALLOWED=YES" >> ios/Flutter/Generated.xcconfig
          echo "CODE_SIGNING_REQUIRED=NO" >> ios/Flutter/Generated.xcconfig
          echo "CODE_SIGN_IDENTITY=-" >> ios/Flutter/Generated.xcconfig
          echo "PROVISIONING_PROFILE_SPECIFIER=" >> ios/Flutter/Generated.xcconfig

      - name: Build with Fakesign Identity
        run: |
          # هنا لب الموضوع: نمرر الهوية "-" مباشرة لـ xcodebuild أثناء البناء
          flutter build ios --release --no-codesign --extra-front-end-options="--no-implicit-dynamic-calls" \
          --export-method ad-hoc

      - name: Wrap IPA for TrollStore
        run: |
          mkdir -p Payload
          # الآن، وبسبب التوقيع الزائف أثناء البناء، سنجد الملف حتماً
          cp -r build/ios/iphoneos/Runner.app Payload/
          zip -vr Raseed.ipa Payload/
          
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Raseed-TrollStore-Edition
          path: Raseed.ipa
