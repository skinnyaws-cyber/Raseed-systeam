name: Build iOS IPA (TrollStore Final Bypass)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install Dependencies
        run: flutter pub get

      - name: Prepare Project for TrollStore
        run: |
          # 1. تعيين الـ Bundle ID
          sed -i '' 's/com.example.[a-zA-Z0-9]*/com.raseed.app/g' ios/Runner.xcodeproj/project.pbxproj
          
          # 2. تعطيل التوقيع في ملفات الإعدادات
          echo "CODE_SIGNING_ALLOWED=NO" >> ios/Flutter/Generated.xcconfig
          echo "CODE_SIGNING_REQUIRED=NO" >> ios/Flutter/Generated.xcconfig
          echo "CODE_SIGN_IDENTITY=" >> ios/Flutter/Generated.xcconfig

      - name: Build with Direct Xcode Command
        run: |
          # سنستخدم أمر xcodebuild مباشرة لتخطي قيود Flutter
          set -o pipefail
          xcodebuild -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            clean build | xcpretty

      - name: Create IPA for TrollStore
        run: |
          mkdir -p Payload
          # البحث عن ملف الـ .app ووضعه في الـ Payload
          cp -r build/ios/iphoneos/Runner.app Payload/ || cp -r ~/Library/Developer/Xcode/DerivedData/*/Build/Products/Release-iphoneos/Runner.app Payload/
          zip -r Raseed.ipa Payload
          
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Raseed-App-IPA
          path: Raseed.ipa
