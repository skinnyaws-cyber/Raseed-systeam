name: Build iOS IPA (TrollStore Ready)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install Dependencies
        run: flutter pub get

      - name: Force Disable Signing & Set Bundle ID
        run: |
          # 1. تعيين الـ Bundle ID الذي اقترحته
          sed -i '' 's/com.example.[a-zA-Z0-9]*/com.raseed.app/g' ios/Runner.xcodeproj/project.pbxproj
          
          # 2. حذف متطلبات التوقيع من ملف المشروع بعمق
          sed -i '' '/CODE_SIGN_STYLE/d' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' '/DEVELOPMENT_TEAM/d' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' '/PROVISIONING_PROFILE/d' ios/Runner.xcodeproj/project.pbxproj
          
          # 3. إجبار Xcode على وضع "التوقيع اليدوي" الفارغ
          echo "CODE_SIGNING_ALLOWED=NO" >> ios/Flutter/Generated.xcconfig
          echo "CODE_SIGNING_REQUIRED=NO" >> ios/Flutter/Generated.xcconfig
          echo "CODE_SIGN_IDENTITY=" >> ios/Flutter/Generated.xcconfig
          echo "EXPANDED_CODE_SIGN_IDENTITY=" >> ios/Flutter/Generated.xcconfig

      - name: Build iOS (No-Sign Bypass)
        run: |
          # نستخدم أمر flutter build مع تمرير إعدادات إضافية لـ xcodebuild مباشرة
          flutter build ios --release --no-codesign \
            --extra-front-end-options="--no-implicit-dynamic-calls" \
            --build-name=1.0.0 --build-number=1

      - name: Create IPA for TrollStore
        run: |
          mkdir -p Payload
          # نسخ ملف التطبيق المجمع
          cp -r build/ios/iphoneos/Runner.app Payload/
          # ضغطه كملف IPA
          zip -vr Raseed.ipa Payload/
          
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Raseed-App-IPA
          path: Raseed.ipa
